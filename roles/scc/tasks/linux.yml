---
- name: Ensure /tmp/scc directory exists
  ansible.builtin.file:
    path: /tmp/scc
    state: directory
    mode: '0755'

- name: Determine SCC installer source for Linux
  ansible.builtin.set_fact:
    scc_src: >-
      {% if ansible_os_family == 'RedHat' and ansible_distribution_major_version | default('8') | string == '7' %}
      files/scc-5.14_rhel7_x86_64/scc-5.14.rhel7.x86_64.rpm
      {% elif ansible_os_family == 'RedHat' %}
      files/scc-5.14_rhel8_x86_64/scc-5.14.rhel8.x86_64.rpm
      {% else %}
      files/scc-5.14_ubuntu18_amd64/scc-5.14.ubuntu.18_amd64.deb
      {% endif %}
    scc_ext: "{{ '.deb' if ansible_os_family == 'Debian' else '.rpm' }}"

- name: Copy SCC installer to Linux target
  ansible.builtin.copy:
    src: "{{ scc_src | trim }}"
    dest: "/tmp/scc/scc-installer{{ scc_ext }}"
    mode: '0644'

- name: Install SCC on RedHat variants
  ansible.builtin.yum:
    name: "/tmp/scc/scc-installer.rpm"
    state: present
    disable_gpg_check: true
  when: ansible_os_family == 'RedHat'

- name: Install SCC on Debian variants
  ansible.builtin.apt:
    deb: "/tmp/scc/scc-installer.deb"
    state: present
  when: ansible_os_family == 'Debian'

- name: Run SCC local scan on Linux
  ansible.builtin.command:
    cmd: /opt/scc/cscc
  register: scc_linux_scan
  changed_when: "scc_linux_scan.rc == 0"
  ignore_errors: true

- name: Find SCC scan results archive
  ansible.builtin.find:
    paths: "~/SCC/Sessions"
    patterns: "*_Results_*.zip"
    recurse: true
  register: scc_linux_results

- name: Fetch Linux scan results to controller
  ansible.builtin.fetch:
    src: "{{ item.path }}"
    dest: "scc_results/{{ inventory_hostname }}/"
    flat: true
  loop: "{{ scc_linux_results.files }}"
  when: scc_linux_results.matched > 0
