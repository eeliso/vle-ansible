---
- name: Ensure C:\Temp\scc directory exists
  ansible.windows.win_file:
    path: C:\Temp\scc
    state: directory

- name: Copy SCC installer to Windows target
  ansible.windows.win_copy:
    src: "scc-5.14_Windows/SCC_5.14_Windows_Setup.exe"
    dest: C:\Temp\scc\SCC_5.14_Windows_Setup.exe

- name: Install SCC on Windows
  ansible.windows.win_command:
    cmd: C:\Temp\scc\SCC_5.14_Windows_Setup.exe /S /v"/qn"
  register: scc_install_result
  changed_when: scc_install_result.rc in [0, 3010]
  failed_when: scc_install_result.rc not in [0, 3010]

- name: Run SCC local scan on Windows
  ansible.windows.win_command:
    cmd: '"C:\Program Files\SCAP Compliance Checker\cscc.exe"'
  register: scc_windows_scan
  changed_when: "scc_windows_scan.rc == 0"
  ignore_errors: true

- name: Archive SCC sessions directory for fetching on Windows
  ansible.windows.win_shell:
    cmd: "Compress-Archive -Path $env:USERPROFILE\\SCC\\Sessions -DestinationPath C:\\Temp\\scc_sessions.zip -Force"
  register: scc_windows_archive
  changed_when: false
  ignore_errors: true

- name: Fetch Windows scan results archive to controller
  ansible.builtin.fetch:
    src: "C:\\Temp\\scc_sessions.zip"
    dest: "scc_results/{{ inventory_hostname }}/scc_sessions.zip"
    flat: true
  when: scc_windows_archive.rc == 0
